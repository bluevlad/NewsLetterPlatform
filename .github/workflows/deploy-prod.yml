name: Deploy to Production

on:
  push:
    branches:
      - prod

env:
  DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        run: |
          cd ${{ env.DEPLOY_PATH }}
          git fetch origin prod
          git reset --hard origin/prod

      - name: Create .env.production file
        run: |
          cd ${{ env.DEPLOY_PATH }}
          cat > .env.production << EOF
          # Auto-generated by GitHub Actions
          # $(date)

          # Gmail SMTP
          GMAIL_ADDRESS=${{ secrets.GMAIL_ADDRESS }}
          GMAIL_APP_PASSWORD=${{ secrets.GMAIL_APP_PASSWORD }}

          # Database
          DATABASE_URL=sqlite:///./data/newsletterplatform.db

          # Scheduler (24h format, KST)
          # EduFit
          EDUFIT_COLLECT_HOUR=7
          EDUFIT_COLLECT_MINUTE=20
          EDUFIT_SEND_HOUR=8
          EDUFIT_SEND_MINUTE=20

          # AllergyInsight
          ALLERGY_COLLECT_HOUR=7
          ALLERGY_COLLECT_MINUTE=30
          ALLERGY_SEND_HOUR=8
          ALLERGY_SEND_MINUTE=30

          # Tenant API URLs
          EDUFIT_API_URL=http://host.docker.internal:9070/api/v1
          ALLERGY_INSIGHT_API_URL=http://host.docker.internal:9040
          ALLERGY_INSIGHT_API_TOKEN=${{ secrets.ALLERGY_INSIGHT_API_TOKEN }}

          # Web Server
          WEB_HOST=0.0.0.0
          WEB_PORT=4050
          WEB_BASE_URL=http://www.unmong.com:4050

          # Logging
          LOG_LEVEL=INFO

          # Admin
          ADMIN_PASSWORD=${{ secrets.ADMIN_PASSWORD }}
          EOF

      - name: Build and Deploy
        run: |
          cd ${{ env.DEPLOY_PATH }}

          echo "Stopping existing containers..."
          docker compose -f docker-compose.prod.yml down --remove-orphans || true
          docker rm -f newsletterplatform-web newsletterplatform-scheduler 2>/dev/null || true

          echo "Building containers..."
          docker compose -f docker-compose.prod.yml build

          echo "Starting containers..."
          docker compose -f docker-compose.prod.yml up -d

      - name: Health Check
        run: |
          cd ${{ env.DEPLOY_PATH }}
          echo "Waiting for services to start..."
          sleep 10

          echo "Container Status:"
          docker compose -f docker-compose.prod.yml ps

          for i in $(seq 1 6); do
            if curl -sf http://localhost:4050/ > /dev/null 2>&1; then
              echo "Web service health check passed!"
              exit 0
            fi
            echo "Retry $i/6..."
            sleep 5
          done
          echo "Health check failed!"
          exit 1

      - name: Cleanup
        if: success()
        run: docker image prune -f
