{% extends "admin/admin_base.html" %}

{% block title %}Scheduler{% endblock %}
{% block page_title %}Scheduler Monitor{% endblock %}

{% block content %}
<!-- Health Status -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-label">Scheduler Health</div>
        <div class="stat-value">
            {% if health_ok %}
            <span style="color: var(--action-color);">Healthy</span>
            {% else %}
            <span style="color: var(--danger-color);">Unhealthy</span>
            {% endif %}
        </div>
        <div class="stat-sub">
            <span id="health-live"
                  hx-get="/admin/api/health"
                  hx-trigger="every 30s"
                  hx-swap="innerHTML">
            </span>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Last Collect</div>
        <div class="stat-value text-sm" style="font-size: 1rem;">{{ health_data.get('collect', 'N/A') }}</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Last Send</div>
        <div class="stat-value text-sm" style="font-size: 1rem;">{{ health_data.get('send', 'N/A') }}</div>
    </div>
</div>

<!-- Schedule Config per Tenant -->
<div class="card">
    <div class="card-header">
        <h3>Schedule Configuration</h3>
    </div>
    <div class="table-wrap">
        <table>
            <thead>
                <tr>
                    <th>Tenant</th>
                    <th>Type</th>
                    <th>Schedule</th>
                    <th>Collect Time</th>
                    <th>Send Time</th>
                </tr>
            </thead>
            <tbody>
            {% for info in schedule_info %}
                <tr>
                    <td>
                        <span class="badge badge-info">{{ info.tenant.tenant_id }}</span>
                        {{ info.tenant.display_name }}
                    </td>
                    <td><span class="badge badge-info">daily</span></td>
                    <td class="text-sm text-muted">Every day</td>
                    <td>
                        <span style="font-family: monospace; font-weight: 600;">{{ info.collect_time }}</span>
                        <span class="text-muted text-xs">UTC</span>
                    </td>
                    <td>
                        <span style="font-family: monospace; font-weight: 600;">{{ info.send_time }}</span>
                        <span class="text-muted text-xs">UTC</span>
                    </td>
                </tr>
                {% if info.weekly_config %}
                <tr style="background: rgba(56, 189, 248, 0.05);">
                    <td></td>
                    <td><span class="badge" style="background: rgba(56, 189, 248, 0.2); color: #38bdf8;">weekly</span></td>
                    <td class="text-sm text-muted">Every {{ info.weekly_config.day_of_week }}</td>
                    <td>
                        <span style="font-family: monospace; font-weight: 600;">{{ info.weekly_config.collect_time }}</span>
                        <span class="text-muted text-xs">UTC</span>
                    </td>
                    <td>
                        <span style="font-family: monospace; font-weight: 600;">{{ info.weekly_config.send_time }}</span>
                        <span class="text-muted text-xs">UTC</span>
                    </td>
                </tr>
                {% endif %}
                {% if info.monthly_config %}
                <tr style="background: rgba(245, 158, 11, 0.05);">
                    <td></td>
                    <td><span class="badge" style="background: rgba(245, 158, 11, 0.2); color: #f59e0b;">monthly</span></td>
                    <td class="text-sm text-muted">Day {{ info.monthly_config.day_of_month }} of month</td>
                    <td>
                        <span style="font-family: monospace; font-weight: 600;">{{ info.monthly_config.collect_time }}</span>
                        <span class="text-muted text-xs">UTC</span>
                    </td>
                    <td>
                        <span style="font-family: monospace; font-weight: 600;">{{ info.monthly_config.send_time }}</span>
                        <span class="text-muted text-xs">UTC</span>
                    </td>
                </tr>
                {% endif %}
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Health File Raw Data -->
<div class="card mt-2">
    <div class="card-header">
        <h3>Health File Raw</h3>
    </div>
    <pre style="background: rgba(15,23,42,0.6); padding: 1rem; border-radius: 8px; font-size: 0.8rem; color: var(--text-muted); overflow-x: auto;">{{ health_data | tojson(indent=2) }}</pre>
</div>
{% endblock %}
