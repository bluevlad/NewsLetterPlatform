<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AllergyInsight - ì•ŒëŸ¬ì§€ ë‰´ìŠ¤ ë¸Œë¦¬í•‘</title>
</head>
<body style="margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Noto Sans KR', sans-serif; background-color: #f0f4f0;">
    <table width="100%" cellpadding="0" cellspacing="0" style="max-width: 700px; margin: 0 auto; background-color: #ffffff;">
        <!-- Header -->
        <tr>
            <td style="background: linear-gradient(135deg, #2e7d32 0%, #1b5e20 100%); padding: 35px 30px; text-align: center;">
                <h1 style="margin: 0; color: #ffffff; font-size: 28px; font-weight: 700;">ğŸŒ¿ AllergyInsight</h1>
                <p style="margin: 8px 0 0 0; color: rgba(255,255,255,0.9); font-size: 15px;">ì•ŒëŸ¬ì§€ ë‰´ìŠ¤ & ë…¼ë¬¸ ë¸Œë¦¬í•‘</p>
                <p style="margin: 12px 0 0 0; color: #ffffff; font-size: 20px; font-weight: 500;">{{ report_date.strftime('%Yë…„ %mì›” %dì¼') }}</p>
            </td>
        </tr>

        <!-- Greeting -->
        <tr>
            <td style="padding: 30px 30px 20px 30px;">
                <p style="margin: 0; color: #333333; font-size: 16px;">
                    êµ¬ë…ìë‹˜, ì•ˆë…•í•˜ì„¸ìš”.
                </p>
                <p style="margin: 10px 0 0 0; color: #666666; font-size: 15px;">
                    ì˜¤ëŠ˜ì˜ ì•ŒëŸ¬ì§€ ê´€ë ¨ ì†Œì‹ì„ ì „í•´ë“œë¦½ë‹ˆë‹¤.
                </p>
            </td>
        </tr>

        <!-- Stats Summary -->
        <tr>
            <td style="padding: 0 30px 25px 30px;">
                <table width="100%" cellpadding="0" cellspacing="0">
                    <tr>
                        <td style="background-color: #e8f5e9; border-radius: 8px; padding: 15px; text-align: center;">
                            <span style="color: #2e7d32; font-weight: 600; font-size: 14px;">
                                ğŸ“° ë‰´ìŠ¤ {{ stats.news_count }}ê±´ &nbsp;|&nbsp; ğŸ“Š ë™í–¥ë¶„ì„ {{ stats.trend_company_count }}ê±´ &nbsp;|&nbsp; ğŸ“š ë…¼ë¬¸ {{ stats.paper_count }}ê±´
                            </span>
                        </td>
                    </tr>
                </table>
            </td>
        </tr>

        <!-- TOP News -->
        {% if top_news %}
        <tr>
            <td style="padding: 0 30px 25px 30px;">
                <h2 style="margin: 0 0 15px 0; padding-bottom: 10px; border-bottom: 2px solid #2e7d32; color: #1b5e20; font-size: 18px;">
                    â­ ì˜¤ëŠ˜ì˜ ì£¼ìš” ë‰´ìŠ¤
                </h2>

                {% for item in top_news[:3] %}
                <table width="100%" cellpadding="0" cellspacing="0" style="margin-bottom: 15px;">
                    <tr>
                        <td style="background-color: #fafafa; border-left: 4px solid #2e7d32; border-radius: 0 8px 8px 0; padding: 18px;">
                            <h3 style="margin: 0 0 8px 0; font-size: 16px;">
                                <a href="{{ item.link }}" style="color: #333333; text-decoration: none;">{{ item.title }}</a>
                            </h3>
                            <p style="margin: 0 0 10px 0; color: #888888; font-size: 12px;">
                                {% if item.category %}[{{ item.category }}] {% endif %}
                                {% if item.source %}{{ item.source }} Â· {% endif %}
                                {% if item.pub_date %}{{ item.pub_date }}{% endif %}
                                {% if item.importance_score %}
                                <span style="color: #e53935; margin-left: 8px;">ì¤‘ìš”ë„ {{ (item.importance_score * 100)|int }}%</span>
                                {% endif %}
                            </p>
                            <p style="margin: 0; color: #555555; font-size: 14px; line-height: 1.6;">
                                {{ (item.summary or item.description or '')[:200] }}{% if (item.summary or item.description or '')|length > 200 %}...{% endif %}
                            </p>
                        </td>
                    </tr>
                </table>
                {% endfor %}
            </td>
        </tr>
        {% endif %}

        <!-- ê¸°ì—… ë™í–¥ ë¶„ì„ -->
        {% if company_news %}
        <tr>
            <td style="padding: 0 30px 25px 30px;">
                <h2 style="margin: 0 0 15px 0; padding-bottom: 10px; border-bottom: 2px solid #37474f; color: #263238; font-size: 18px;">
                    ğŸ“Š ê¸°ì—… ë™í–¥ ë¶„ì„
                </h2>

                {% for company in company_news %}
                {% if company.type == 'main' %}
                <!-- ê³ ê°ì‚¬ ë¸”ë¡ -->
                <table width="100%" cellpadding="0" cellspacing="0" style="margin-bottom: 18px; border-left: 4px solid #2e7d32; border-radius: 0 8px 8px 0; background-color: #f1f8e9;">
                    <tr>
                        <td style="padding: 14px 16px 8px 16px;">
                            <span style="display: inline-block; background-color: #2e7d32; color: #ffffff; font-size: 11px; font-weight: 600; padding: 3px 8px; border-radius: 4px; margin-right: 6px;">ê³ ê°ì‚¬</span>
                            <span style="font-size: 15px; font-weight: 700; color: #1b5e20;">{{ company.name }}</span>
                            <span style="color: #999999; font-size: 12px; margin-left: 6px;">({{ company.articles|length }}ê±´)</span>
                        </td>
                    </tr>
                    {% if company.trend_summary %}
                    <tr>
                        <td style="padding: 0 16px 10px 16px;">
                            <p style="margin: 0; color: #2e7d32; font-size: 13px; font-style: italic; line-height: 1.4;">
                                ğŸ’¡ {{ company.trend_summary }}
                            </p>
                        </td>
                    </tr>
                    {% endif %}
                    {% if company.articles %}
                    {% for item in company.articles[:3] %}
                    <tr>
                        <td style="padding: 6px 16px 8px 16px; {% if not loop.last %}border-bottom: 1px solid #c8e6c9;{% endif %}">
                            <h4 style="margin: 0 0 4px 0; font-size: 14px; font-weight: 500;">
                                <a href="{{ item.link }}" style="color: #333333; text-decoration: none;">{{ item.title }}</a>
                            </h4>
                            <p style="margin: 0; color: #888888; font-size: 11px;">
                                {% if item.source %}{{ item.source }}{% endif %}
                                {% if item.pub_date %} Â· {{ item.pub_date }}{% endif %}
                                {% if item.importance_score %}
                                <span style="color: #e53935; margin-left: 6px;">ì¤‘ìš”ë„ {{ (item.importance_score * 100)|int }}%</span>
                                {% endif %}
                            </p>
                            {% if item.summary %}
                            <p style="margin: 4px 0 0 0; color: #666666; font-size: 13px; line-height: 1.5;">
                                {{ item.summary[:150] }}{% if item.summary|length > 150 %}...{% endif %}
                            </p>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                    {% else %}
                    <tr>
                        <td style="padding: 6px 16px 14px 16px;">
                            <p style="margin: 0; color: #999999; font-size: 13px; font-style: italic;">ìµœê·¼ ê´€ë ¨ ë‰´ìŠ¤ ì—†ìŒ</p>
                        </td>
                    </tr>
                    {% endif %}
                </table>
                {% else %}
                <!-- ê²½ìŸì‚¬ ë¸”ë¡ -->
                <table width="100%" cellpadding="0" cellspacing="0" style="margin-bottom: 18px; border-left: 4px solid #546e7a; border-radius: 0 8px 8px 0; background-color: #fafafa;">
                    <tr>
                        <td style="padding: 14px 16px 8px 16px;">
                            <span style="display: inline-block; background-color: #546e7a; color: #ffffff; font-size: 11px; font-weight: 600; padding: 3px 8px; border-radius: 4px; margin-right: 6px;">ê²½ìŸì‚¬</span>
                            <span style="font-size: 15px; font-weight: 700; color: #37474f;">{{ company.name }}</span>
                            <span style="color: #999999; font-size: 12px; margin-left: 6px;">({{ company.articles|length }}ê±´)</span>
                        </td>
                    </tr>
                    {% if company.trend_summary %}
                    <tr>
                        <td style="padding: 0 16px 10px 16px;">
                            <p style="margin: 0; color: #546e7a; font-size: 13px; font-style: italic; line-height: 1.4;">
                                ğŸ’¡ {{ company.trend_summary }}
                            </p>
                        </td>
                    </tr>
                    {% endif %}
                    {% if company.articles %}
                    {% for item in company.articles[:3] %}
                    <tr>
                        <td style="padding: 6px 16px 8px 16px; {% if not loop.last %}border-bottom: 1px solid #eceff1;{% endif %}">
                            <h4 style="margin: 0 0 4px 0; font-size: 14px; font-weight: 500;">
                                <a href="{{ item.link }}" style="color: #333333; text-decoration: none;">{{ item.title }}</a>
                            </h4>
                            <p style="margin: 0; color: #888888; font-size: 11px;">
                                {% if item.source %}{{ item.source }}{% endif %}
                                {% if item.pub_date %} Â· {{ item.pub_date }}{% endif %}
                                {% if item.importance_score %}
                                <span style="color: #e53935; margin-left: 6px;">ì¤‘ìš”ë„ {{ (item.importance_score * 100)|int }}%</span>
                                {% endif %}
                            </p>
                            {% if item.summary %}
                            <p style="margin: 4px 0 0 0; color: #666666; font-size: 13px; line-height: 1.5;">
                                {{ item.summary[:150] }}{% if item.summary|length > 150 %}...{% endif %}
                            </p>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                    {% else %}
                    <tr>
                        <td style="padding: 6px 16px 14px 16px;">
                            <p style="margin: 0; color: #999999; font-size: 13px; font-style: italic;">ìµœê·¼ ê´€ë ¨ ë‰´ìŠ¤ ì—†ìŒ</p>
                        </td>
                    </tr>
                    {% endif %}
                </table>
                {% endif %}
                {% endfor %}
            </td>
        </tr>
        {% endif %}

        <!-- News by Mega Group -->
        {% for group in news_groups %}
        <tr>
            <td style="padding: 0 30px 25px 30px;">
                <h2 style="margin: 0 0 15px 0; padding-bottom: 10px; border-bottom: 2px solid {{ group.border_color }}; color: {{ group.color }}; font-size: 18px;">
                    {{ group.icon }} {{ group.title }}
                    <span style="color: #888888; font-size: 13px; font-weight: normal; margin-left: 8px;">({{ group.total_count }}ê±´)</span>
                </h2>

                {% for entry in group.entries %}
                <table width="100%" cellpadding="0" cellspacing="0" style="margin-bottom: 10px;">
                    <tr>
                        <td style="padding: 10px 14px; {% if not loop.last %}border-bottom: 1px solid #f0f0f0;{% endif %}">
                            <p style="margin: 0 0 6px 0;">
                                <span style="display: inline-block; background-color: {{ group.bg_color }}; color: {{ group.color }}; font-size: 11px; font-weight: 600; padding: 2px 7px; border-radius: 3px; margin-right: 6px;">{{ entry.category_name }}</span>
                                <a href="{{ entry.article.link }}" style="color: #333333; text-decoration: none; font-size: 14px; font-weight: 500;">{{ entry.article.title }}</a>
                            </p>
                            <p style="margin: 0; color: #888888; font-size: 11px;">
                                {% if entry.article.source %}{{ entry.article.source }}{% endif %}
                                {% if entry.article.pub_date %} Â· {{ entry.article.pub_date }}{% endif %}
                                {% if entry.article.importance_score %}
                                <span style="color: #e53935; margin-left: 6px;">ì¤‘ìš”ë„ {{ (entry.article.importance_score * 100)|int }}%</span>
                                {% endif %}
                            </p>
                        </td>
                    </tr>
                </table>
                {% endfor %}

                {% if group.total_count > group.entries|length %}
                <p style="margin: 5px 0 0 14px; color: #888888; font-size: 12px; font-style: italic;">
                    ì™¸ {{ group.total_count - group.entries|length }}ê±´...
                </p>
                {% endif %}
            </td>
        </tr>
        {% endfor %}

        <!-- Papers Section -->
        {% if papers %}
        <tr>
            <td style="padding: 0 30px 25px 30px;">
                <h2 style="margin: 0 0 15px 0; padding-bottom: 10px; border-bottom: 2px solid #1565c0; color: #0d47a1; font-size: 18px;">
                    ğŸ“š ìµœì‹  ë…¼ë¬¸ (PubMed)
                </h2>

                {% for paper in papers[:5] %}
                <table width="100%" cellpadding="0" cellspacing="0" style="margin-bottom: 12px;">
                    <tr>
                        <td style="background-color: #e3f2fd; border-radius: 6px; padding: 14px;">
                            <h4 style="margin: 0 0 6px 0; font-size: 14px; font-weight: 500;">
                                <a href="{{ paper.link }}" style="color: #1565c0; text-decoration: none;">{{ paper.title[:100] }}{% if paper.title|length > 100 %}...{% endif %}</a>
                            </h4>
                            <p style="margin: 0; color: #666666; font-size: 11px;">
                                {{ paper.journal or '' }}
                                {% if paper.pmid %} | PMID: {{ paper.pmid }}{% endif %}
                                {% if paper.pub_date %} | {{ paper.pub_date }}{% endif %}
                            </p>
                        </td>
                    </tr>
                </table>
                {% endfor %}

                {% if papers|length > 5 %}
                <p style="margin: 5px 0 0 0; color: #888888; font-size: 12px; font-style: italic;">
                    ì™¸ {{ papers|length - 5 }}ê±´ì˜ ë…¼ë¬¸ì´ ìˆìŠµë‹ˆë‹¤...
                </p>
                {% endif %}
            </td>
        </tr>
        {% endif %}

        <!-- No Data Message -->
        {% if not top_news and not papers %}
        <tr>
            <td style="padding: 40px 30px; text-align: center;">
                <p style="color: #888888; font-size: 16px;">
                    ì˜¤ëŠ˜ì€ ìˆ˜ì§‘ëœ ì†Œì‹ì´ ì—†ìŠµë‹ˆë‹¤.
                </p>
            </td>
        </tr>
        {% endif %}

        <!-- Footer -->
        <tr>
            <td style="background-color: #f5f5f5; padding: 30px; text-align: center; border-top: 1px solid #eeeeee;">
                <p style="margin: 0 0 10px 0; color: #888888; font-size: 12px;">
                    ì´ ë©”ì¼ì€ AllergyInsight ì‹œìŠ¤í…œì—ì„œ ìë™ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.
                </p>
                <p style="margin: 0 0 15px 0; color: #aaaaaa; font-size: 11px;">
                    <a href="__UNSUBSCRIBE_URL__" style="color: #aaaaaa; text-decoration: underline;">êµ¬ë… í•´ì§€</a>
                </p>
                <p style="margin: 0; color: #cccccc; font-size: 11px;">
                    ìƒì„± ì‹œê°„: {{ generated_at.strftime('%Y-%m-%d %H:%M:%S') }}
                </p>
            </td>
        </tr>
    </table>
</body>
</html>
